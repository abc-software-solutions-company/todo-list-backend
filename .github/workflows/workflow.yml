name: Deploy to Production

on:
  push:
    branches: ["main"]

env:
  APP_ENV: ${{ secrets.PRODUCTION }}

jobs:
  build:
    name: "Deploy to Production"
    environment:
      name: Production

    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [16.x]

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: Delete old env file
        run: rm -r -f .env

      - name: Create env_temp file
        run: touch .env_temp

      - name: Copy Secret Key Multiline environment variable to .env_temp file
        run: echo $APP_ENV | tee .env_temp

      - name: Replace space character with break-line in .env file
        run: sed 's/ /\n/g' .env_temp >> .env

      - name: Remove .env_temp file
        run: rm -r -f .env_temp

      - name: Install Yarn, PM2 (Install first time only, after that this command run quickly)
        run: npm install -g yarn pm2

      - name: Remove package-lock.json (Prevent error or conflicted version of npm, yarn, etc when developer forgot to delete it in pull request)
        run: rm -r -f package-lock.json

      - name: Install or Update Node Module from package.json
        run: yarn

      - name: Build Optimized Production Backend
        run: yarn build

      - name: Copy all file (After build successfull) to Backend Server Folder (Default Folder defined by Linux Home Directory)
        run: cp -rf ./ $HOME/dist

      - name: Change directory to Backend Server Folder and restart Backend Server. Add Crontab to restart server every 5 hour
        run: |
          RUNNER_TRACKING_ID="" && \
          cd $HOME/dist && \
          pm2 start "yarn start" --cron-restart="0 0 0/5 ? * * *" && \
          pm2 restart "yarn start" --cron-restart="0 0 0/5 ? * * *"
